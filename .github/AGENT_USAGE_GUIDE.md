# GitHub Copilot カスタムエージェント使用ガイド

このドキュメントでは、トークン消費を最小化しながら、サブエージェントを活用した効率的な開発ワークフローの使用方法を説明します。

---

## 📋 概要

このプロジェクトでは、GitHub Copilot のカスタムエージェント機能を使って、以下のような構成を実現しています:

- **メインセッション**: オーケストレーター（タスク振り分けのみ）
- **サブエージェント**: 専門作業者（実装、調査、レビュー等）

### メリット

- ✅ メインセッションのトークン消費を大幅削減
- ✅ 各タスクに最適な専門エージェントが対応
- ✅ 人間の承認フローが組み込まれた安全な実装
- ✅ 段階的な作業で品質向上

---

## 🗂️ ファイル構成

```
.github/
├── copilot-instructions.md          # メインオーケストレーター指示
├── agents/                           # サブエージェント定義
│   ├── planner.agent.md             # プラン作成専門
│   ├── implementation.agent.md      # 実装専門
│   ├── code-review.agent.md         # コードレビュー専門
│   ├── security-review.agent.md     # セキュリティレビュー専門
│   └── documentation.agent.md       # ドキュメント作成専門
└── instructions/                     # パス固有の指示
    └── web-fetch.instructions.md    # Web調査サブエージェント用
```

---

## 🚀 基本的な使用方法

### 1. 新機能の実装

**ユーザー（あなた）:**
> 「ユーザーの週次使用状況を表示する機能を追加してください」

**メインセッション（オーケストレーター）の動作:**

1. **タスク分類**（メインセッション）
   ```markdown
   このタスクは新機能実装です。
   プラン作成 → 実装 → セキュリティレビューの順で進めます。
   ```

2. **プラン作成の委任**
   ```
   runSubagent("Plan", "
   タスク: ユーザーの週次使用状況表示機能を追加
   
   以下を含むプランを作成してください:
   - 変更が必要なファイルリスト
   - 実装手順
   - 推定時間
   - 影響範囲
   
   ※コード変更は行わず、プランのみ作成
   ")
   ```

3. **ユーザー承認**（ask_questions）
   ```markdown
   プランナーから以下の実装プランを受け取りました:
   
   [プランの要約を表示]
   
   次のアクションを選択してください:
   - このプランで実装を開始
   - プランを修正
   - 追加情報が必要
   ```

4. **実装の委任**（ユーザーが承認したら）
   ```
   runSubagent("実装", "
   以下のプランに基づいて実装してください:
   [プランの内容]
   
   完了後の報告形式:
   - 変更ファイル: [リスト]
   - テスト結果: [成功/失敗]
   - 注意事項: [あれば]
   ")
   ```

5. **コードレビュー**（実装完了後）
   ```
   runSubagent("コードレビュー", "
   実装されたコードの品質をレビューしてください
   設計・可読性・テスト・パフォーマンスの観点で評価
   ")
   ```

6. **セキュリティレビュー**（コードレビュー完了後）
   ```
   runSubagent("セキュリティ", "
   実装されたコードをOWASP Top 10に基づいてレビューしてください
   ")
   ```

6. **完了報告**（メインセッション）
   ```markdown
   全ての作業が完了しました。
   
   [各ステップの結果サマリー]
   
   次のアクション:
   - 手動動作確認
   - デプロイ準備
   - 追加機能の実装
   ```

---

## 🤖 利用可能なサブエージェント

### 1. Planエージェント

**用途:** 実装プラン作成、設計ドキュメント生成

**呼び出し方:**
```
runSubagent("Plan", "タスク内容...")
```

**特徴:**
- 📖 **読み取り専用** - コード変更は行わない
- 🔍 既存パターンの調査
- 📋 詳細な実装手順の提示
- ⏱️ 推定時間の算出

**返却内容:**
- 変更が必要なファイルリスト
- 実装手順（ステップバイステップ）
- 推定影響範囲
- 潜在的なリスクと対策

---

### 2. 実装エージェント

**用途:** コード実装、テスト実行、バグ修正

**呼び出し方:**
```
runSubagent("実装", "プランに基づいて実装...")
```

**特徴:**
- ✍️ **コード編集・実装**
- 🧪 テスト自動実行
- 🔧 エラーの即時修正
- 📝 変更ログの記録

**返却内容:**
- 変更ファイル一覧
- テスト結果（成功/失敗）
- ビルド確認結果
- 注意事項・既知の問題

---

### 3. コードレビューエージェント

**用途:** コード品質評価、設計・可読性レビュー

**呼び出し方:**
```
runSubagent("コードレビュー", "実装されたコードをレビュー...")
```

**特徴:**
- 📝 **8カテゴリのチェック**（設計・機能性・複雑さ・テスト・命名・スタイル・パフォーマンス・ドキュメント）
- 🏷️ **重要度ラベル付き指摘**（Required / Suggestion / Nit / FYI / Praise）
- 👏 **良い実装の称賛も含む**
- 📊 Google Engineering Practices 準拠

**返却内容:**
- 品質評価（⭐評価）
- カテゴリ別チェック結果
- 重要度ラベル付きの指摘リスト
- 改善提案

---

### 4. セキュリティレビューエージェント

**用途:** 脆弱性検出、セキュリティ評価

**呼び出し方:**
```
runSubagent("セキュリティ", "実装されたコードをレビュー...")
```

**特徴:**
- 🔒 **OWASP Top 10 準拠チェック**
- 📝 言語固有の安全性検証
- 📊 リスクレベル評価
- 💡 具体的な修正提案

**返却内容:**
- 検出された脆弱性リスト（Critical / High / Medium / Low）
- 各脆弱性の詳細説明と修正案
- 自動スキャン結果（依存関係脆弱性、静的解析）
- 推奨される次のアクション

---

### 5. Web調査エージェント

**用途:** Web情報収集、ドキュメント調査

**呼び出し方:**
```
runSubagent("Web調査", "調査したいトピック...")
```

**特徴:**
- 🌐 **Web情報の要約取得**
- 🚀 複数URL並行フェッチ
- 📚 構造化された返却
- 🔗 情報源URL明記

**返却内容:**
- 調査結果の要約
- 重要コード例（必要時のみ）
- 情報源URL
- 取得ステータス

---

### 6. ドキュメント作成エージェント

**用途:** ドキュメント作成・更新、テクニカルライティング

**呼び出し方:**
```
runSubagent("ドキュメント", "READMEを作成...")
```

**特徴:**
- 📝 **Diátaxis フレームワーク準拠**（Tutorial / How-to / Reference / Explanation）
- ✨ Google/Microsoft スタイルガイドに従ったテクニカルライティング
- 📊 コードベース調査に基づく正確な記述
- 📄 各種テンプレート（README / CHANGELOG / APIドキュメント）

**返却内容:**
- 作成されたドキュメントファイル
- 品質チェックリスト
- 推奨される次のアクション

---

## 💡 使用例

### 例1: バグ修正

**ユーザー:**
> 「カレンダー表示でタイムゾーンがおかしいバグを修正して」

**推奨フロー:**

1. 直接実装エージェントに委任（バグ修正は調査不要な場合）
   ```
   runSubagent("実装", "
   バグ修正: カレンダー表示のタイムゾーン問題
   
   症状: [ユーザーの説明]
   
   修正後、以下を報告:
   - 原因
   - 修正内容
   - テスト結果
   ")
   ```

2. セキュリティ影響確認（必要に応じて）

---

### 例2: 新技術の調査 → 実装

**ユーザー:**
> 「新しい async 機能を使ってリファクタリングしたい」

**推奨フロー:**

1. **Web調査**
   ```
   runSubagent("Web調査", "
   async/await 最新ベストプラクティスを調査
   
   調査範囲:
   - 公式ドキュメント
   - 主要なブログ記事
   
   返却形式:
   - 重要ポイント3-5個
   - コード例1-2個
   ")
   ```

2. **ユーザー承認** → **プラン作成**
   ```
   runSubagent("Plan", "
   調査結果に基づき、以下のリファクタリングプランを作成:
   [調査結果の要約]
   
   対象: 同期処理部分
   ")
   ```

3. **ユーザー承認** → **実装** → **コードレビュー** → **セキュリティレビュー**

---

### 例3: セキュリティ重視の機能追加

**ユーザー:**
> 「ユーザー認証機能を追加して」

**推奨フロー:**

1. **Web調査**（認証ベストプラクティス）
2. **プラン作成**（セキュリティ考慮した設計）
3. **ユーザー承認**
4. **実装**
5. **コードレビュー**（品質確認）
6. **セキュリティレビュー**（必須）
7. **修正が必要なら実装エージェントに再委任**

---

## ⚙️ カスタマイズ方法

### 新しいサブエージェントの追加

1. **`.github/agents/your-agent.agent.md` を作成**

```markdown
---
description: あなたのエージェントの説明
tools: ['read_file', 'search']  # 必要最小限のツールのみ
agents: []  # サブエージェント禁止なら空配列
user-invokable: true  # UIから呼び出し可能
model: Claude Sonnet 4.5 (copilot)
---

# あなたのエージェント名

## 役割
...

## 動作原則
...

## 返却フォーマット
...
```

2. **メインオーケストレーターに追加**

[.github/copilot-instructions.md](../.github/copilot-instructions.md) の「サブエージェント委任ルール」セクションに追記:

```markdown
| **あなたのタスクタイプ** | `runSubagent("your-agent", "...")` | 説明 |
```

---

### パス固有の規約追加

**例: Python ファイル用規約を追加**

1. **`.github/instructions/python.instructions.md` を作成**

```markdown
---
applyTo: "**/*.py"
---

# Python コーディング規約

## 基本原則
...
```

2. **自動適用**
   - 該当パスのファイルを編集する際に自動適用される
   - メインオーケストレーターには追加設定不要

---

## 🎯 ベストプラクティス

### ✅ Do

1. **段階的な承認**
   - 各フェーズでユーザー承認を挟む
   - 誤った方向への無駄なトークン消費を防ぐ

2. **明確なゴール定義**
   - サブエージェントに渡すプロンプトは具体的に
   - 返却形式を明示

3. **トークン効率を意識**
   - メインセッションは簡潔に
   - 詳細作業はサブエージェントに委任

4. **セキュリティ重視**
   - 認証・認可系の機能は必ずセキュリティレビュー

### ❌ Don't

1. **メインセッションでの実装**
   - 実装はサブエージェントに任せる
   - メインは振り分けのみ

2. **承認なしの連続実行**
   - 長いチェーンは途中でエラーが起きやすい
   - 各ステップで確認

3. **サブエージェントの過度なネスト**
   - サブエージェントからサブエージェントは最小限に
   - 複雑化を避ける

---

## 🔧 トラブルシューティング

### サブエージェントが期待通りに動作しない

**原因:**
- プロンプトが不明確
- 必要なツールが付与されていない

**解決策:**
1. サブエージェント定義の `tools` フィールドを確認
2. プロンプトに具体的な指示と返却形式を明示

---

### メインセッションが実装を始めてしまう

**原因:**
- オーケストレーター指示が読み込まれていない

**解決策:**
1. [.github/copilot-instructions.md](../.github/copilot-instructions.md) が存在するか確認
2. VS Code / GitHub Copilot を再起動

---

### トークン消費が多い

**原因:**
- サブエージェントが冗長な出力を返している
- メインセッションで不要な分析をしている

**解決策:**
1. サブエージェントのプロンプトに「簡潔に要約」を明示
2. メインセッションは30-100トークン以内の応答を心がける

---

## 📚 参考リソース

- [GitHub Copilot カスタムインストラクション公式ドキュメント](https://docs.github.com/en/copilot/customizing-copilot/adding-custom-instructions-for-github-copilot)
- [VS Code カスタムエージェント](https://code.visualstudio.com/docs/copilot/customization/custom-agents)
- [Anthropic: Building Effective Agents](https://www.anthropic.com/research/building-effective-agents)
- [OWASP Top 10](https://owasp.org/www-project-top-ten/)

---

## 🎉 まとめ

このカスタムエージェント構成により、以下を実現できます:

- 🚀 **トークン効率**: メインセッションのトークン消費を最大90%削減
- 🎯 **専門性**: 各タスクに最適なエージェントが対応
- 🛡️ **安全性**: 人間の承認フローで品質担保
- 📈 **拡張性**: 新しいエージェントの追加が容易

ぜひ活用して、効率的な開発を実現してください！
